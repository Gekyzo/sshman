# SSH Man - Tab Completion Guide

## Quick Start

### Installation

```bash
cd completions
./install.sh
source ~/.bashrc  # bash
source ~/.zshrc   # zsh
```

### Usage

```bash
./sshman use [TAB]      # Lists available SSH keys
./sshman [TAB]          # Lists available commands
./sshman use --[TAB]    # Lists available options
```

## How It Works

### Architecture

1. **Java Layer** (`UseCommand.java`)
   - `KeyNameCompletionCandidates` class scans `~/.ssh` directory
   - Filters out non-key files (`.pub`, `config`, `known_hosts`, `authorized_keys`)
   - Validates private keys by checking for `-----BEGIN` header
   - Returns key names as completion candidates

2. **Shell Layer** (bash/zsh scripts)
   - Bash: Auto-generated by picocli's `AutoComplete` tool
   - Zsh: Custom implementation in `_sshman`
   - Both scripts call the Java completion logic dynamically

### Key Files

- `completions/sshman_completion.bash` - Bash completion (14KB)
- `completions/_sshman` - Zsh completion (3.3KB)
- `completions/install.sh` - Installation script
- `src/main/java/com/sshman/UseCommand.java:199-227` - Key detection logic

## Manual Installation

### Bash

```bash
# User installation
mkdir -p ~/.bash_completion.d
cp completions/sshman_completion.bash ~/.bash_completion.d/
echo '[ -f ~/.bash_completion.d/sshman_completion.bash ] && source ~/.bash_completion.d/sshman_completion.bash' >> ~/.bashrc
source ~/.bashrc
```

### Zsh

```bash
# User installation
mkdir -p ~/.zsh/completion
cp completions/_sshman ~/.zsh/completion/
echo 'fpath=(~/.zsh/completion $fpath)' >> ~/.zshrc
echo 'autoload -Uz compinit && compinit' >> ~/.zshrc
source ~/.zshrc
```

## Regenerating Completion Scripts

After modifying command structure or options:

```bash
# Build the project
mvn clean package

# Regenerate bash completion
java -cp target/sshman-0.1.0-jar-with-dependencies.jar \
  picocli.AutoComplete com.sshman.SshMan \
  -n sshman -o completions/sshman_completion.bash -f

# IMPORTANT: Add "./sshman" support to the generated file
# Edit the last line of completions/sshman_completion.bash:
# Change: complete -F _complete_sshman -o default sshman sshman.sh sshman.bash
# To:     complete -F _complete_sshman -o default sshman sshman.sh sshman.bash ./sshman

# Reinstall
cd completions && ./install.sh
```

## Troubleshooting

### Tab shows file paths instead of SSH keys

**Problem:** Running `./sshman use [TAB]` shows directory contents instead of SSH keys.

**Cause:** Completion not registered for `./sshman` (relative path).

**Solution:** 
```bash
# Verify the last line of completions/sshman_completion.bash includes "./sshman"
tail -1 completions/sshman_completion.bash
# Should show: complete -F _complete_sshman -o default sshman sshman.sh sshman.bash ./sshman

# If missing, add it and reinstall
cd completions && ./install.sh
source ~/.bashrc
```

### Completion not working at all

```bash
# 1. Verify completion is sourced
type _picocli_sshman  # bash
which _sshman         # zsh

# 2. Check completion is registered
complete -p | grep sshman  # bash
echo $fpath               # zsh (should include completion dir)

# 3. Reinstall
cd completions && ./install.sh
source ~/.bashrc  # or ~/.zshrc
```

### Keys not appearing in completion

```bash
# 1. Verify keys exist and are valid
./sshman list

# 2. Check key permissions
ls -l ~/.ssh/

# 3. Test Java completion directly
java -cp target/sshman-0.1.0-jar-with-dependencies.jar com.sshman.SshMan use --help
```

## Implementation Details

### Supported Command Variants

The completion works with:
- `sshman` (if in PATH)
- `./sshman` (relative path)
- `sshman.sh`
- `sshman.bash`

### Custom Path Support

Completion respects the `--path` option:
```bash
./sshman use --path /custom/ssh/dir [TAB]  # Lists keys from custom directory
```

### Completion Features by Command

| Command | Completion Support |
|---------|-------------------|
| `generate` | Algorithm options, flags |
| `list` | Flags only |
| `info` | SSH key names |
| `use` | SSH key names |
| All | `--help`, `--version` |

## Technical Notes

### Why picocli AutoComplete?

- Automatically generates completion from command annotations
- Supports dynamic completion via `completionCandidates`
- Maintains consistency between CLI and completion
- Cross-platform support (bash, zsh, fish)

### Known Limitations

- Fish shell not yet supported
- Windows PowerShell completion not implemented
- Nested subdirectories under `~/.ssh` show full paths in completion

## Future Enhancements

- [ ] Fish shell support
- [ ] PowerShell completion (Windows)
- [ ] Smart caching of key list for performance
- [ ] Completion for `--algo` values in `generate` command
- [ ] Fuzzy matching for key names

## References

- [picocli AutoComplete Documentation](https://picocli.info/autocomplete.html)
- [Bash Completion Guide](https://github.com/scop/bash-completion)
- [Zsh Completion System](https://zsh.sourceforge.io/Doc/Release/Completion-System.html)
